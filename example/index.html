<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Secure Trading Example Form</title>
</head>

<body>
<form id="st-form" action="https://www.example.com" class="example-form" autocomplete="off" novalidate>
    <div id="st-popup"></div>
    <h1 class="example-form__title">
        Secure Trading<span>AMOUNT: <strong>10.00 GBP</strong></span>
    </h1>
    <div class="example-form__section example-form__section--horizontal">
        <div class="example-form__group">
            <label for="example-form-name" class="example-form__label">AMOUNT</label>
            <input
                    id="example-form-amount"
                    class="example-form__input"
                    type="number"
                    placeholder=""
                    name="myBillAmount"
                    data-st-name="billingamount"
            />
        </div>
    </div>

    <div class="example-form__section example-form__section--horizontal">
        <div class="example-form__group">
            <label for="example-form-name" class="example-form__label">NAME</label>
            <input
                    id="example-form-name"
                    class="example-form__input"
                    type="text"
                    placeholder="John Doe"
                    autocomplete="name"
                    name="myBillName"
                    data-st-name="billingfirstname"
            />
        </div>
        <div class="example-form__group">
            <label for="example-form-email" class="example-form__label">E-MAIL</label>
            <input
                    id="example-form-email"
                    class="example-form__input"
                    type="email"
                    placeholder="test@mail.com"
                    autocomplete="email"
                    name="myBillEmail"
                    data-st-name="billingemail"
            />
        </div>
        <div class="example-form__group">
            <label for="example-form-phone" class="example-form__label">PHONE</label>
            <input
                    id="example-form-phone"
                    class="example-form__input"
                    type="tel"
                    placeholder="+00 000 000 000"
                    autocomplete="tel"
                    name="myBillTel"
            />
            <!-- no data-st-name attribute so this field will not be submitted to ST -->
        </div>
    </div>

    <div class="example-form__spacer"></div>

    <div class="example-form__section">
        <div id="st-notification-frame" class="example-form__group"></div>
        <div id="st-card-number" class="example-form__group"></div>
        <div id="st-expiration-date" class="example-form__group"></div>
        <div id="st-security-code" class="example-form__group"></div>
    </div>

    <div id="st-animated-card" class="example-form__st-animated-card"></div>

    <div class="example-form__section">
        <div class="example-form__group example-form__group--submit">
            <button type="submit" class="example-form__button" id="additional-button" hidden>Additional button</button>
        </div>
        <div class="example-form__group example-form__group--submit">
            <button type="submit" class="example-form__button" id="merchant-submit-button">Zapłać</button>
        </div>
    </div>

    <div class="example-form__section">
        <div id="st-control-frame" class="example-form__group"></div>
        <div id="st-visa-checkout" class="example-form__group"></div>
        <div id="st-apple-pay" class="example-form__group"></div>
    </div>
</form>
<script type="text/javascript" src="<%= WEBSERVICES_URL %>/inlineConfig.js"></script>
<script type="text/javascript" src="<%= WEBSERVICES_URL %>/st.js"></script>
<script type="text/javascript">
  (function() {
    var ST = SecureTrading;
    var params = new URLSearchParams(window.location.search.substring(1));
    var inlineConfig = params.get('inlineConfig') ? JSON.parse(params.get('inlineConfig')) : '';
    var jwt = params.get('jwt') || '';
    var updatedJwt = params.get('updatedJwt') || '';
    var extraFunction = params.get('extraFunction');

    if (inlineConfig) {
      init(ST, inlineConfig);
    } else {
      window
        .fetch('<%= WEBSERVICES_URL %>/config.json')

        .then(function(response) {
          if (response.status !== 200) {
            return Promise.reject('Configuration has not been set !');
          }
          return response.json();
        })
        .then(function(data) {
          try {
            getJwt(ST, data);
          } catch (e) {
            console.error(e);
          }
        })
        .catch(function() {
          getDefaultConfig(ST);
        });
    }


    function getDefaultConfig(ST) {
      fetch('./../json/config.json')
        .then(function(response) {
          if (response.status !== 200) {
            return Promise.reject('Default configuration has not been set !');
          }
          return response.json();
        })
        .then(function(data) {
          if (data) {
            getJwt(ST, data);
          }
        });
    }

    function updateJwtListener(st) {
      document.getElementById('example-form-amount').addEventListener('input', function() {
        st.updateJWT(updatedJwt);
      });
    }

    function buildPopup(id, text, tp) {
      if (document.getElementById(id)) {
        return;
      }
      var popupStyling = 'display: flex; justify-content: center; position: fixed; height: 70px;right:0;color: white;padding: 0 50px;align-items: center;border-radius: 10px;font-family: Verdana;font-size: 20px;z-index:2';
      var div = document.createElement('div');
      div.innerText = text;
      div.setAttribute('id', id);
      div.setAttribute('style', popupStyling);
      div.style.backgroundColor = tp;
      switch (tp) {
        case 'green':
          div.style.top = 0;
          break;
        case 'blue':
          div.style.top = '100px';
          break;
        default:
          div.style.bottom = 0;
      }
      return div;
    }

    function displayPopup(id, text, tp) {
      var popup = document.getElementById('st-popup');
      var content = buildPopup(id, text, tp);
      popup.appendChild(content);
      setTimeout(function() {
        popup.removeChild(content);
      }, 3000);
    }

    function setCallbacks(config) {
      if (extraFunction) {
        config.submitCallback = eval('(' + extraFunction + ')');
      } else {
        config.submitCallback = function(data) {
          var stringified = JSON.stringify(data);
          var testVariable = 'This is what we have got after submit' + stringified;
          displayPopup('data-popup', 'Error code: ' + (!data || data.errorcode != '0' ? 'Error' : 'OK'), 'blue');
          console.error(testVariable);
        };
      }
      config.successCallback = function() {
        displayPopup('success-popup', 'This is success message', 'green');
      };
      config.errorCallback = function() {
        displayPopup('error-popup', 'This is error message', 'red');
      };
      config.cancelCallback = function() {
        displayPopup('cancel-popup', 'This is cancel message', '#ffc23a');
      };
    }

    function init(ST, config) {
      setCallbacks(config);
      var st = ST(config);
      st.Components(config.components);
      st.VisaCheckout(config.visaCheckout);
      st.ApplePay(config.applePay);
      st.Cybertonica().then(function(response) {
        console.error(response);
      });
      updateJwtListener(st);
    }

    function getJwt(ST, data) {
      var stConfig = data;
      if (jwt) {
        stConfig.jwt = jwt;
        init(ST, stConfig);
      }

      window.configJWT('./../json/jwtdata.json').then(function(generatedJwt) {
        stConfig.jwt = generatedJwt;
        init(ST, stConfig);
      }).catch(function() {
        init(ST, stConfig);
      });
    }
  })();
</script>
</body>
</html>


